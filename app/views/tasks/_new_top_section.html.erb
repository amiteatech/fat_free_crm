<div class="taskForm">
  <div class="halfLeft">
    <div class="blockForm2">
      <label class="top req task_name">Task Title:</label>      
      <div class="span2">
       <%= f.text_field :name, :autofocus => true %>
      </div>
    </div>
    <div class="blockForm2">
      <label class="top task_name">Year:</label>      
      <div class="span2">
       <%=  f.input :years, label: false , input_html: { minlength: 1, :style => "" }  %>
      </div>
    </div>      
    <!--
   
        <div class="label top req task_name">Description:</div>
        <%#= f.text_area :description %>      
  -->
   <div class="blockForm2 bottom">
      <label class="req">Due:</label>      
      <div class="span2">
       <% with_time = Setting.task_calendar_with_time %>
        <% if @task.bucket != "specific_time" %> 
        <% bucket = (params[:bucket].blank? ? @task.bucket : params[:bucket]) || "due_asap" %>
          <%= f.select :bucket, @bucket, { :selected => bucket.to_sym }, { :style => "", :onload => "crm.flip_calendar(this.value)" } %>
        <%= f.text_field :calendar, :style => "display: none;", :autocomplete => :off, :class => (with_time ? 'datetime' : 'date') %>
        <% else %>
          <%= f.select :bucket, @bucket, { :selected => :specific_time }, { :style => "", :onchange => "crm.flip_calendar(this.value)" } %>
          <% fmt = with_time ? '%Y-%m-%d %H:%M' : '%Y-%m-%d' %>
          <%= f.text_field :calendar, :value => f.object.due_at.strftime(fmt), :style => " display: none;", :autocomplete => :off, :class => (with_time ? 'datetime' : 'date') %>
        <% end %>
      </div>
    </div>

    <div class="blockForm2 bottom">
      <label class="req">Assign to:</label>      
      <div class="span2">
        <%= multi_user_select(:task, all_users, @task.id) %>
      </div>
    </div>
    <% if Setting.background_info && Setting.background_info.include?(:task) %>

    <div class="blockForm2">
      <label class=""><%= t(:extra_info).capitalize << ':' %></label>      
      <div class="span2">
        <%= f.text_area :background_info, :style =>"width:500px", :rows => 3 %>
      </div>
    </div>
    <% end %>
    <%= hook(:task_top_section_bottom, self, :f => f) %>   
  </div>
   <% if @user_tasks.present? %>
  <div class="halfRight">
    <div class="label top req task_name task_assign">Task assigned to:</div>
    <div class="selected_users">
          <ul id="sortable">
            <% if @user_tasks.present? %>
              <% @user_tasks.each do |user_task| %>
                <%  @user = User.find(user_task.user_id) %>
                <li class="user_list ui-state-default" data-utid="UserTask-<%=user_task.id%>">
                  <span class="ui-icon ui-icon-arrowthick-2-n-s"></span>
                  <%= @user.name %>
                
                </li>
              <% end %>
            <% end %>
          </ul>
        </div>    
  </div>
  <% end %>
  <div class="cl"></div>
</div>
<script type="text/javascript">
  $(document).ready( function() {
    // setTimeout(function(){ 
    //   $("ul.select2-selection__rendered li.select2-selection__choice").remove();
    //   $("ul#sortable li").each(function() {
    //     var text = $(this).text();
    //     $("ul.select2-selection__rendered li.select2-search.select2-search--inline").prepend("<li class='select2-selection__choice' title='"+text+"><span class='select2-selection__choice__remove' role='presentation'>Ã—</span>"+text+"</li>");
    //   });
    // }, 300);

  
 



    $( "#sortable" ).sortable({
      start: function(event, ui) {
        // ui.item.startPos = ui.item.index();
      },
      stop: function(event, ui) {
        $("ul#sortable > li").each(function() {
          var index = $(this).index();
          var user_task_id = $(this).data("utid").split("-")[1];
          var arr = { "user_task_id": user_task_id, "position": index+1 };
          $.ajax({
            url: "user_tasks/set_position/",
            data: arr,
            type: 'POST',
            success: function (resp) {
                // alert(resp);
            },
            error: function(e) {
              alert('Error: '+e);
            }  
          });
        });
      }
    });
  });
</script>