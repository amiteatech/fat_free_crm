<div class="taskForm for_task">
  <div class="halfLeft">
    <div class="blockForm2">
      <label class="top req task_name">Task Title:</label>      
      <div class="span2">
       <%= f.text_field :name, :autofocus => true %>
      </div>
    </div>
    <% indx = 0 %>
    <% TaskFormTag.where(:status => true).each do |tag| %>
    <%

     tag_values = TaskFormTagValue.all.where(:company_id => current_user.company_id).where(:task_form_tag_id => tag.id)
    %>
    <% if tag_values.size > 0 %>
    <div class="blockForm2">
      <label class="top task_name"><%= tag.name%>:</label>      
      <div class="span2">
        <%#= select_tag %>
       <% 
         selected_value = ""
         last = @task.option_values.where(:task_form_tag_id => tag.id).last
         if last
            selected_value = last.task_form_tag_value_id
         end   
        

       %>
       <%= select_tag "option_value[#{tag.id}]", options_from_collection_for_select(tag_values, "id", "name", selected_value ), include_blank: "Please select an option", :class => 'select2_tag selectWorkflow' %>
       <%#= task_form_tag_value_id %>
       <%#=  f.input "option_value[#{indx}]", :collection => tag_values.map{|s|[s.name, s.id]}, label: false , input_html: { class: 'select2_tag' }  %>
      </div>
    </div>  
    <% if indx%2 == 0 %>
     <div class="cl"></div>
    <% end %>
    <% indx = indx + 1 %>
    <% end %>
    <% end %>

         
 
   <div class="blockForm2 bottom">
      <label class="req">Due:</label>      
      <div class="span2">
        <%= f.hidden_field :bucket, :value => 'specific_time' %>
       <% with_time = Setting.task_calendar_with_time %>
        <% if @task.bucket != "specific_time" %> 
        <% bucket = (params[:bucket].blank? ? @task.bucket : params[:bucket]) || "due_asap" %>

          <%#= f.select :bucket, @bucket, { :selected => bucket.to_sym }, { :style => "", :onload => "crm.flip_calendar(this.value)" } %>
        <%= f.text_field :calendar, :autocomplete => :off, :class => 'datetime dueAT' %>
        <% else %>
          <%#= f.select :bucket, @bucket, { :selected => :specific_time }, { :style => "", :onchange => "crm.flip_calendar(this.value)" } %>
          <% fmt = with_time ? '%Y-%m-%d %H:%M' : '%Y-%m-%d' %>
          <%= f.text_field :calendar, :value => f.object.due_at.strftime(fmt), :autocomplete => :off, :class => 'datetime dueAT' %>
        <% end %>
      </div>
    </div>

    <div class="blockForm2 ">
      <label class="req">Assign to:</label>      
      <div class="span2">
        <%= multi_user_select(:task, all_users, @task.id) %>
      </div>
    </div>
    <% if Setting.background_info && Setting.background_info.include?(:task) %>

    <div class="blockForm2">
      <label class=""><%= t(:extra_info).capitalize << ':' %></label>      
      <div class="span2">
        <%= f.text_area :background_info, :style =>"width:500px", :rows => 3 %>
      </div>
    </div>
    <% end %>
    <%= hook(:task_top_section_bottom, self, :f => f) %>   
  </div>
   <% if @user_tasks.present? %>
  <div class="halfRight">
    <div class="blockForm2 assigned">
      <label class="req">Task assigned to:</label>
      <div class="selected_users">
          <ul id="sortable">
            <% if @user_tasks.present? %>
              <% @user_tasks.each do |user_task| %>
                  <%  @user = User.find(user_task.user_id) %>
                  <li class="user_list ui-state-default" data-utid="UserTask-<%=user_task.id%>">
                    <span class="ui-icon ui-icon-arrowthick-2-n-s"></span>
                    <%= @user.name %>
                  </li>
              <% end %>
            <% end %>
          </ul>
      </div> 
    </div>   
  </div>
  <% end %>
  <div class="cl"></div>
</div>

<% unless action_name == "new" || @task.task_created_id == current_user.id %>
  <script type="text/javascript">
    $(document).ready(function() {
      $("#task_name, .selectWorkflow, .dueAT, .taskForm .assignedUserSelect").attr("disabled",true);
    });
  </script>
<% end %>

<script type="text/javascript">
  $(document).ready( function() {
    // setTimeout(function(){ 
    //   $("ul.select2-selection__rendered li.select2-selection__choice").remove();
    //   $("ul#sortable li").each(function() {
    //     var text = $(this).text();
    //     $("ul.select2-selection__rendered li.select2-search.select2-search--inline").prepend("<li class='select2-selection__choice' title='"+text+"><span class='select2-selection__choice__remove' role='presentation'>Ã—</span>"+text+"</li>");
    //   });
    // }, 300);
  
 
    $( "#sortable" ).sortable({
      start: function(event, ui) {
        // ui.item.startPos = ui.item.index();
      },
      stop: function(event, ui) {
        $("ul#sortable > li").each(function() {
          var index = $(this).index();
          var user_task_id = $(this).data("utid").split("-")[1];
          var arr = { "user_task_id": user_task_id, "position": index+1 };
          $.ajax({
            url: "user_tasks/set_position/",
            data: arr,
            type: 'POST',
            success: function (resp) {
                // alert(resp);
            },
            error: function(e) {
              alert('Error: '+e);
            }  
          });
        });
      }
    });
  });
</script>
